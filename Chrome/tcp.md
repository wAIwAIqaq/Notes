# TCP/IP

在衡量Web页面性能的时候有一个重要的指标**FP（First Paint）**，是指**从页面加载到首次开始绘制的时长**。这个指标直接影响了用户的跳出率。更快的页面响应意味着更多的PV，更高的参与度，以及更高的转化率。其中一个重要指标就是**网络加载速度**。

要想优Web页面的加载速度。你需要对网络有充分了解。不管是**HTTP**，还是**WebSocket**，他们都是基于TCP/IP的。

#### 一个数据包的“旅程”

我们需要从三个角度去理解：

- 数据包如何送达主机
- 如何将数据包转交给应用
- 数据是如何完整地送达应用程序

**互联网，实际上时一套历练和协议组成的体系架构。**其中，协议是一套众所周知的规则和标准，如果各方都同意使用，那么它们之间的通信将变得毫无障碍。

互联网中的数据是通过数据包来传输的。如果发送的数据很大，那么该数据就会被拆分为很多小数据包来传输。比如音频数据，安装包，是拆分成一个个很小的包来传输的，并不是一个大的文件一次传输过来的。

#### IP （Internet Protocol）把数据包送达目的主机

数据包要在熟练网上传输，就要复合 **网际协议（Internet Protocol）标准**。互联网上不同的在线设备都有唯一的地址，地址只能是一个数字。类似于物流中的地址，只要知道收货地址，就能把物品送到目的地。

**计算机的地址就称为IP地址，访问任何网站实际上只是你的计算机向另一台计算机发送请求信息**

如果想要把一个数据包从主机A发送给主机B，那么在传输之前，数据包会被附上主机B的IP信息，这样在传输过程中才能正确寻址。额外地，数据包上还会附上主机A的IP地址，有了这个主机B才能回复信息给主机A。这些附加信息都会被装进一个叫做IP头的数据结构里。IP头是IP数据包开头的信息，包含IP版本，源IP地址，目标IP地址，生存时间等信息。

![image-20220508171930010](C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20220508171930010.png)

- 上层将数据包交给网络层。

- 网络层再将IP头附加到数据包上，组成新的**IP数据包**，并交给底层

- 底层通过物理网络将数据包传输给主机B

- 数据包被传输到主机B的网络层，在这里主机B拆开数据包的IP头信息，并将拆开的数据部分交给上层

- 最终，数据包被传输到主机B的上层

  

#### UDP把数据包送达应用程序

IP是非常底层的协议，只负责吧数据包传送到对方电脑，但是对方电脑并不知道把数据交给哪个程序。因此，需要基于IP智商开发能和应用打交道的协议，最常见的就是**用户数据包协议(User Datagram Protocol)**,简称UDP。

UDP中一个最重要的信息是**端口号**。通过端口号UDP就能把指定的数据包发送给指定的程序了，所以，**IP通过IP地址信息把数据包发送给指定的电脑，而UDP通过端口号把数据包分发给正确的程序**。和IP头一样，端口号会被装进UDP里面，UDP头在和原始数据包合并组成新的UDP数据包。UPD中除了目的端口，还有源端口号等信息.

为了支持UDP协议，前面的三层结构扩充为四层结构。

![image-20220508180616451](C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20220508180616451.png)

- 上层将数据包交给传输层

- 传输层会在数据包前面附加上**UDP头**，组成新的UDP数据包，再将新的UDP数据包交给网络层

- 网络层再将IP头附加到数据包上，组成新的**IP数据包**，并交给底层

- 底层通过物理网络将数据包传输给主机B

- 数据包被传输到主机B的网络层，在这里主机B拆开数据包的IP头信息，并将拆开的数据部分交给传输层

- 在传输层，**数据包中的UDP头会被拆开，并根据UDP中所提供的的端口号，把数据部分交给上层的应用程序**

- 最终，数据包被传输到主机B的上层。

  

在使用UDP发送数据的时候，有各种原因会导致数据包出错，虽然UDP可以校验数据是否正确，但是对于错误的数据包，UDP并不提供重发机制，只是丢弃当前的报，而且UDP在发送之后也无法知道是否能到达目的地。

虽然**UDP不能保证数据的可靠性，但是传输速度却非常快**，所以UDP会应用在一些关注速度、但不那么严格要求数据完整性的领域，比如在线视频，互动游戏等。

#### TCP把数据完整地送达应用程序

对于浏览器请求，或者邮件这类要求数据传输可靠性的应用，如果使用UDP会导致两个问题

- 数据包在传输过程中容易丢失。
- 大文件会被拆成很多小的数据包来传输，这些小的数据包会进过不同的路由，并在不同的时间到达接收端，而UDP协议并不知道如何组装这些数据包，从而把这些数据包还原成完整的文件

基于这两个问题，我们引入了**TCP（Transmission Control Protocol ，传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议**

- 对于数据包丢失的情况，TCP提供了重传机制

- TCP引入了数据包的排序机制，用来保证乱序的数据包组合成一个完整的文件

  

和UDP头一样，TCP头出了包含了目标端口和本机端口外，还提供了用于排序的序列号，一边接受通过序列号来重排数据包。

![image-20220508181848349](C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20220508181848349.png)

上图展示了一个数据包是如何通过TCP来传输的。TCP单个数据包的传输流程跟UPD差不多，不同的地方在于，通过TCP头的信息保证了一块大的数据传输的完整性。

![image-20220508182623798](C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20220508182623798.png)

- **首先，建立连接阶段**，这个阶段通过’**三次握手**来建立he护短和服务器之间的链接。TCP提供面向连接的通信传输。**面向连接**是指在数据通信开始之前先做好了两端的准备工作。**三次握手**，建立一个TCP连接时，客户端和服务端总共要发送三个数据包确认连接的建立。
- **其次，传输数据阶段**在这个阶段，接收端需要对每个数据包进行确认操作，也就是接收端在接受到数据包之后，需要发送确认数据包给发送端。所以当发送端发送了一个数据包之后，在规定事件内没有接收到接收端反馈的确认消息，则判断为数据包丢失，并触发发送端的重发机制。同样，一个大的文件在传输过程中会被拆分成很多小的数据包，这些数据包到达接收端后，接收端会按照TCP头中的需要为其排序，从而保证组成数据的完整性。
- **最后，断开连接阶段**。数据传输完毕后就要终止连接了，涉及到最后一个阶段**四次挥手**来保证双方都能断开连接。

